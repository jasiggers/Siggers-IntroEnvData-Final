---
title: "LAGOS Spatial Analysis"
author: "Alex Siggers"
date: "`r format(Sys.time(), '%m/%d/%y')`"
output: html_document
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    )
    rmarkdown::render(
      input,
      output_file = 'index',
      output_dir='./'
---


```{r LAGOS setup, include=FALSE}
library(tidyverse) # Tidy packages
library(sf) #Spatial package that can read and create shapefiles 
library(mapview) #Interactive maps
library(LAGOSNE) #Lots and lots of clean lake data
library(USAboundaries) #USA states and counties
library(RApiSerialize) 
library(dplyr)
library(lubridate) #For dealing with date and time
```

#Chapter 4: LAGOS Spatial Analysis Part One


```{r LAGOS data-read,  include=FALSE, echo=FALSE}
# LAGOS Analysis


## Loading in data


### First download and then specifically grab the locus (or site lat longs)


# #Lagos download script
LAGOSNE::lagosne_get(dest_folder = LAGOSNE:::lagos_path())

#Load in lagos
lagos <- lagosne_load()

#Grab the lake centroid info
lake_centers <- lagos$locus

```



```{r, include=FALSE, echo=FALSE}
###Convert to spatial data

#Look at the column names

names(lake_centers)

#Look at the structure
#str(lake_centers)

#View the full dataset
#View(lake_centers %>% slice(1:100))

spatial_lakes <- st_as_sf(lake_centers,coords=c('nhd_long','nhd_lat'),
                          crs=4326) %>%
  st_transform(2163)

#Subset for plotting
subset_spatial <- spatial_lakes %>%
  slice(1:100) 

subset_baser <- spatial_lakes[1:100,]

#Dynamic mapviewer
mapview(subset_spatial)

```


```{r, include=FALSE, echo=FALSE}
### Subset to only Minnesota

states <- us_states()

#Plot all the states to check if they loaded
#mapview(states)
minnesota <- states %>%
  filter(name == 'Minnesota') %>%
  st_transform(2163)

#Subset lakes based on spatial position
minnesota_lakes <- spatial_lakes[minnesota,]

#Plotting the first 1000 lakes
minnesota_lakes %>%
  arrange(-lake_area_ha) %>%
    slice(1:1000) %>%
  mapview(.,zcol = 'lake_area_ha')
```



# In-Class work


## 1) Show a map outline of Iowa and Illinois (similar to Minnesota map upstream)

```{r, echo=TRUE}
iowa <- states %>%
  filter(name == 'Iowa') %>%
  st_transform(2163)

illinois <- states %>%
  filter(name == 'Illinois') %>%
  st_transform(2163)

mapview(iowa) +
  mapview(illinois)

```



## 2) Subset LAGOS data to these sites, how many sites are in Illinois and Iowa combined? How does this compare to Minnesota?

```{r, echo=TRUE}

iowa_lakes <- spatial_lakes[iowa,]
illinois_lakes <- spatial_lakes[illinois,]

```

-Iowa has 4,644 lakes total, and Illinois has 11,822. This combines to about ~16,500+ lakes, which is about half as many as Minnesota contains (29,038). Minnesota has a ton of lakes.


## 3) What is the distribution of lake size in Iowa vs. Minnesota?

- Here I want to see a histogram plot with lake size on x-axis and frequency on 
y axis (check out geom_histogram)

```{r, echo=TRUE, warning=FALSE, message=FALSE}
ggplot(minnesota_lakes, aes(x= lake_area_ha)) + 
  geom_histogram() + 
  scale_x_log10(labels = scales::comma) +
  ylab("Lake Area (ha)") +
  xlab("Number of lakes") +
  ggtitle("Minnesota Lakes")

ggplot(iowa_lakes, aes(x= lake_area_ha)) +
  geom_histogram() +
  scale_x_log10(labels = scales::comma) +
  ylab("Lake Area (ha)") +
  xlab("Number of lakes") +
  ggtitle("Iowa Lakes")

```

-Minnesota has many more lakes that take up over 1,000 hectares, with a few reaching 5,000 hectares. The lakes in Iowa top out around 1,100 hectares.


## 4) Make an interactive plot of lakes in Iowa and Illinois and color them by lake area in hectares

```{r, echo=TRUE}
Iowanois=rbind(iowa_lakes, illinois_lakes)

Iowanois %>%
  arrange(-lake_area_ha) %>%
    slice(1:1000) %>%
  mapview(.,zcol = 'lake_area_ha')
```


## 5) What other data sources might we use to understand how reservoirs and natural lakes vary in size in these three states? 

-Aquifer depletion/depth, precipitation, long-term climate data, and glacial movement data would help to explain these size differences. Land use change data might also help to explain the manmade lakes. 



##Part 2


```{r data-read, include=FALSE, echo=FALSE}
#Lagos download script
#lagosne_get(dest_folder = LAGOSNE:::lagos_path(),overwrite=T)

#Load in lagos
lagos <- lagosne_load()


#Grab the lake centroid info
lake_centers <- lagos$locus

# Make an sf object 
spatial_lakes <- st_as_sf(lake_centers,coords=c('nhd_long','nhd_lat'),
                          crs=4326)

#Grab the water quality data
nutr <- lagos$epi_nutr

#Look at column names
#names(nutr)
```



```{r, include=FALSE}
### Subset columns nutr to only keep key info that we want
clarity_only <- nutr %>%
  select(lagoslakeid,sampledate,chla,doc,secchi) %>%
  mutate(sampledate = as.character(sampledate) %>% ymd(.))

```



```{r, include=FALSE}
### Keep sites with at least 200 observations 

#Look at the number of rows of dataset
#nrow(clarity_only)

chla_secchi <- clarity_only %>%
  filter(!is.na(chla),
         !is.na(secchi))

# How many observatiosn did we lose?
# nrow(clarity_only) - nrow(chla_secchi)


# Keep only the lakes with at least 200 observations of secchi and chla
chla_secchi_200 <- chla_secchi %>%
  group_by(lagoslakeid) %>%
  mutate(count = n()) %>%
  filter(count > 200)


```




```{r, include=FALSE}
### Join water quality data to spatial data
spatial_200 <- inner_join(spatial_lakes,chla_secchi_200 %>%
                            distinct(lagoslakeid,.keep_all=T),
                          by='lagoslakeid')


```



```{r, include=FALSE}
### Mean Chl_a map

### Take the mean chl_a and secchi by lake

mean_values_200 <- chla_secchi_200 %>%
  # Take summary by lake id
  group_by(lagoslakeid) %>%
  # take mean chl_a per lake id
  summarize(mean_chl = mean(chla,na.rm=T),
            mean_secchi=mean(secchi,na.rm=T)) %>%
  #Get rid of NAs
  filter(!is.na(mean_chl),
         !is.na(mean_secchi)) %>%
  # Take the log base 10 of the mean_chl
  mutate(log10_mean_chl = log10(mean_chl))

#Join datasets
mean_spatial <- inner_join(spatial_lakes,mean_values_200,
                          by='lagoslakeid') 

#Make a map
mapview(mean_spatial,zcol='log10_mean_chl')
```


# Class work

## 1) What is the correlation between Secchi Disk Depth and Chlorophyll a for
sites with at least 200 observations?

- Here, I just want a plot of chla vs secchi for all sites 

```{r, echo=TRUE, include=TRUE}
ggplot(mean_values_200,
       aes(x = mean_secchi,
           y = log10_mean_chl)) +
  geom_smooth(method = "lm") +
  annotate(geom = "text",
           x = 7, 
           y = 3.5,
           label = paste0("r = ", round(cor(mean_values_200$mean_secchi, 
                                            mean_values_200$log10_mean_chl), 3))) +
  xlab("Avg Secchi Disk Depth") +
  ylab("Chlorophyll A (Log10 Transformed)") +
  geom_point(size = 2) +
  theme_light()

```


## Why might this be the case? 
-A higher Chlorophyll A content is typically correlated with increased algae/phytoplankton levels, which would limit the visibility of the lake at depth. In other words, the Secchi Disk will not be visible deeper in the lake when there is an increased amount of biomass (Chlorophyll A) on the surface.

## 2) What states have the most data? 

### 2a) First you will need to make a lagos spatial dataset that has the total 
number of counts per site.

```{r, echo=TRUE, include=TRUE}

NutData <- lagos$epi_nutr

counts <- NutData %>%
  group_by(lagoslakeid) %>%
  mutate(count = n()) %>% 
  inner_join(spatial_lakes, ., by='lagoslakeid') 

```


### 2b) Second, you will need to join this point dataset to the us_boundaries 
data. 

```{r, echo=TRUE, include=TRUE}

states=us_states()

JointData = st_join(states, counts)

```


### 2c) Then you will want to group by state and sum all the observations in that
state and arrange that data from most to least total observations per state. 

```{r, echo=TRUE, include=TRUE}

StateLakes <- aggregate(count ~ state_name, data = JointData, FUN = sum)
StateLakes <- arrange(StateLakes, desc(count))

```

-Minnesota, Wisconsin, Michigan, Maine, and Vermont have the most data out of the 21 states with available data. These states have been the most shaped by natural glacial activity, hence there are many lakes within each. 


##3 Is there a spatial pattern in Secchi disk depth for lakes with at least 200 
observations?

```{r, echo=TRUE, include=TRUE}

mapview(mean_spatial,
        zcol = "mean_secchi")

```


-It appears that most of the lakes in the middle-Midwestern United States have a shallowed mean Secchi Disk Depth than in the northeastern portion of the country. This could be related to nutrient runoff and leaching from agricultural production, but that is extrapolation. However, this is the most notable trend as these lakes display a typical mean depth between 1-4m. 

